"use strict";
var unirest = require("unirest");
var TestRail = (function () {
    function TestRail(options) {
        this.options = options;
        // compute base url
        this.base = "https://" + options.domain + "/index.php";
    }
    TestRail.prototype._post = function (api, body, callback, error) {
        var req = unirest("POST", this.base)
            .query("/api/v2/" + api)
            .headers({
            "content-type": "application/json"
        })
            .type("json")
            .send(body)
            .auth(this.options.username, this.options.password)
            .end(function (res) {
            if (res.error) {
                console.log("Error: %s", JSON.stringify(res.body));
                if (error) {
                    error(res.error);
                }
                else {
                    throw new Error(res.error);
                }
            }
            callback(res.body);
        });
    };
    TestRail.prototype.publish = function (passes, fails, pending, out, tests, callback) {
        var _this = this;
        var total = passes + fails + pending;
        var results = [];
        for (var _i = 0, tests_1 = tests; _i < tests_1.length; _i++) {
            var test_1 = tests_1[_i];
            results.push({
                "case_id": test_1.caseId,
                "status_id": test_1.pass ? 1 : 5,
                "comment": test_1.comment ? test_1.comment : "",
            });
        }
        console.log("Publishing " + results.length + " test result(s) to " + this.base);
        var executionDateTime = new Date().toISOString();
        this._post("add_run/" + this.options.projectId, {
            "suite_id": this.options.suiteId,
            "name": "Automated test run " + executionDateTime,
            "description": "Automated test run executed on " + executionDateTime + "\nExecution summary:\nPasses: " + passes + "\nFails: " + fails + "\nPending: " + pending + "\nTotal: " + total + "\n\nExecution details:\n" + out.join('\n') + "                     \n",
            "assignedto_id": this.options.assignedToId,
            "include_all": true
        }, function (body) {
            var runId = body.id;
            console.log("Results published to " + _this.base + "?/runs/view/" + runId);
            _this._post("add_results_for_cases/" + runId, {
                results: results
            }, function (body) {
                // execute callback if specified
                if (callback) {
                    callback();
                }
            });
        });
    };
    return TestRail;
}());
exports.TestRail = TestRail;
//# sourceMappingURL=testrail.js.map